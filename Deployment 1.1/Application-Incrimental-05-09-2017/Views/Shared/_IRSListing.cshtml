@model IEnumerable<Bill2Pay.Model.MerchantListVM>
<script>
    var AllowRedirect = false;

    function SetSelecAllMerchant(oBj) {
        var strAcnos = $('#checkedAccountNo').val();
        var acno = JSON.parse(strAcnos);

        for (var i = 0; i < acno.length; i++) {
            acno[i].IsChecked = (oBj.checked) ? '1' : '0';
        }
        strAcnos = JSON.stringify(acno);
        $('#checkedAccountNo').val(strAcnos);
        CheckItems();
    }

    function GetSelectedMerchant(accno) {
        var strAcnos = $('#checkedAccountNo').val();
        var acno = JSON.parse(strAcnos);
        for (var i = 0; i < acno.length; i++) {
            if (acno[i].AccountNumber == accno) {
                acno[i].IsChecked = (acno[i].IsChecked == '0') ? "1" : "0";
                break;
            }
        }
        strAcnos = JSON.stringify(acno);
        $('#checkedAccountNo').val(strAcnos);

        ValidatCheckAll();
    }

    function submitForm(statusId) {
        var form = $('#IRSListing');

        $('#statusId').val(statusId);
        form.submit();
    }

    $(document).ready(function () {
        var strAcnos = $('#checkedAccountNo').val();
        var acno = JSON.parse(strAcnos);

        for (var i = 0; i < acno.length; i++) {
            acno[i].IsChecked = "0"; // Unselecting all checkboxes
            $("input[name='" + acno[i].AccountNumber + "']").attr('checked', (acno[i].IsChecked == "1"));
        }

        strAcnos = JSON.stringify(acno);
        $('#checkedAccountNo').val(strAcnos);

        $('#dataTable')
            .on('order.dt', function () { return CheckItems(); })
            .on('search.dt', function () { return CheckItems(); })
            .on('page.dt', function () { return setTimeout(CheckItems, 200); })
            .DataTable({
                "columnDefs": [
                  { "orderable": false, "targets": [0, 1, 7, 8] }
                ],
                order: [[2, 'asc']],
            });

        $('select[name=dataTable_length]').change(function () {
            CheckItems();
        });

    });

    function CheckItems() {
        var strAcnos = $('#checkedAccountNo').val();
        var acno = JSON.parse(strAcnos);
        for (var i = 0; i < acno.length; i++) {
            $('#chkAccountNo_' + acno[i].AccountNumber).prop('checked', acno[i].IsChecked == '1');
        }
    }

    function ValidatCheckAll() {
        var strAcnos = $('#checkedAccountNo').val();
        var acno = JSON.parse(strAcnos);
        var isAllCheck = true;
        for (var i = 0; i < acno.length; i++) {
            if (acno[i].IsChecked == '0') {
                isAllCheck = false;
                break;
            }
        }

        $('#chkSelectAll').prop('checked', isAllCheck);
    }

    function InitPageReload() {
        var cookieName = "_FileDownloaded";
        AllowRedirect = false;
        eraseCookie(cookieName);
        ReloadPage(cookieName);
        return true;
    }

    function ReloadPage(name) {
        var cookieValue = getCookie(name);
        if (cookieValue == "DONE") {
            AllowRedirect = true;
        }

        if (AllowRedirect) {
            window.location.href = window.location.href;
        }
        else {
            setTimeout(ReloadPage, 200, name);
        }
    }

    function getCookie(name) {
        var parts = document.cookie.split(name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    function expireCookie(cName) {
        document.cookie =
            encodeURIComponent(cName) + "=deleted; expires=" + new Date(0).toUTCString();
    }
    function createCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }

    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name, "", -1);
    }

    function RedirectPage(url){
        window.location.href = url;
    }
</script>

<div class="row">
    @using (Html.BeginForm("Process", "IRSProcess", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "form-horizontal", role = "form", Id = "IRSListing" }))
    {
        @Html.AntiForgeryToken()

        @Html.Hidden("checkedAccountNo", (object)@ViewBag.lstmerchantAcc)
        @Html.Hidden("statusId", "");
        @Html.Partial("_SelectYear", new Bill2Pay.Web.YearSelection() { AllowPostback = true, IsVisible = true })

        <div class="col-md-12">


            @{
                if (Request.IsAuthenticated && User.IsInRole("Admin"))
                {


                    <button class="btn  btn-primary" type="submit" name="tinmatching" value="TIN Matching Input" onclick="return InitPageReload();">TIN Matching Input</button>
                    <button class="btn  btn-primary" type="submit" name="irstest" value="IRS FIRE Test Input" onclick="return InitPageReload();">IRS FIRE Test Input</button>
                    <button class="btn  btn-primary" type="submit" name="irs" value="IRS FIRE Input" onclick="return InitPageReload();">IRS FIRE Input </button>
                    <button class="btn  btn-primary" type="submit" name="irscorrection" value="IRS FIRE Correction Input" onclick="return InitPageReload();">IRS FIRE Correction Input</button>
                    <div class="dropdown" style="float:right">
                        <button class="btn btn-success dropdown-toggle" type="submit" data-toggle="dropdown">
                            Change Status
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="submitForm(1);">Not Submitted</a></li>
                            <li><a href="#" onclick="submitForm(6);">Submitted</a></li>
                            <li class="divider"></li>
                            <li><a href="#" onclick="submitForm(3);">One-Transaction Correction</a></li>
                            <li><a href="#" onclick="submitForm(7);">Two-Transaction Correction</a></li>

                        </ul>
                    </div>
                    <button class="btn  btn-primary" type="submit" name="generatepdf" value="Generate PDF File" onclick="return InitPageReload();">Generate PDF File </button>
                }

            }
            <hr />
        </div>
        <div class="col-md-12">

            <table id="dataTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        @if (User.IsInRole("Admin"))
                        {
                            <th><input id="chkSelectAll" onclick="SetSelecAllMerchant(this);" title="Select All" type="checkbox" style="margin-left:-8px;" /></th>
                        }
                        <th align="center"><span style="margin-left:16px;white-space: nowrap;">1099-K</span></th>
                        <th align="left">Client Code</th>
                        <th align="left">TIN</th>
                        <th align="left">Merchant Name</th>
                        <th align="left">Address</th>
                        <th align="left">MCC</th>
                        <th>TIN Status</th>
                        <th>IRS Status</th>

                    </tr>
                </thead>
                <tbody>
                    @{

                        if (Model != null)
                        {
                            if (Model.Count() == 0)
                            {
                                <tr>
                                    <td> </td>
                                    <td style="width:100px" align="center"> </td>
                                    <td> </td>
                                    <td> </td>
                                    <td><span>No data found </span></td>
                                    <td> </td>
                                    <td> </td>
                                    <td> </td>
                                    <td> </td>
                                </tr>

                            }
                            else
                            {
                                foreach (var item in Model)
                                {
                                    <tr>
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <td>
                                                <input id="chkAccountNo_@item.ImportDetails.AccountNumber" class="tblchk" onclick="GetSelectedMerchant('@item.ImportDetails.AccountNumber');" type="checkbox" name="@item.ImportDetails.AccountNumber" />&nbsp;
                                            </td>
                                        }
                                        <td style="width:100px" align="center">

                                            <a href="@Url.Action("Details", new { Id = item.ImportDetails.AccountNumber,year=ViewBag.SelectedYear })" alt="1099K">
                                                <i class="fa fa-files-o fa-lg" title="Generate 1099-K Copies" alt="1099K"></i>
                                            </a>


                                        </td>
                                        @{
                                            if (@item.SubmissionStatus != null)
                                            {

                                                if (@item.SubmissionStatus.StatusId == 7 && User.IsInRole("Admin"))
                                                {
                                                    <td style="color: #337ab7;cursor: pointer;" title="Edit" onclick="RedirectPage('@Url.Action("Edit", "Merchant", new { Id = item.ImportDetails.AccountNumber,year=ViewBag.SelectedYear })')">
                                                        @item.ImportDetails.AccountNumber
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td>
                                                        @item.ImportDetails.AccountNumber
                                                    </td>
                                                }
                                            }
                                            else
                                            {
                                                <td>
                                                    @item.ImportDetails.AccountNumber
                                                </td>
                                            }
                                        }
                                        @*<td>
                                                @{
                                                    if (@item.SubmissionStatus != null)
                                                    {

                                                        if (@item.SubmissionStatus.StatusId == 7 && User.IsInRole("Admin"))
                                                        {
                                                            <a href="@Url.Action("Edit", "Merchant", new { Id = item.ImportDetails.AccountNumber,year=ViewBag.SelectedYear })" title="Edit">
                                                                @item.ImportDetails.AccountNumber
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            @item.ImportDetails.AccountNumber
                                                        }
                                                    }
                                                    else
                                                    {
                                                        @item.ImportDetails.AccountNumber
                                                    }
                                                }

                                            </td>*@
                                        <td>@item.ImportDetails.TIN </td>
                                        <td>@item.ImportDetails.FirstPayeeName  </td>
                                        <td>@item.ImportDetails.PayeeMailingAddress </td>
                                        <td>@item.ImportDetails.MerchantCategoryCode</td>
                                        <td align="center">
                                            @{
                                                if (!string.IsNullOrEmpty(@item.ImportDetails.TINCheckStatus))
                                                {
                                                    if (@item.ImportDetails.TINCheckStatus.Equals("0", StringComparison.InvariantCultureIgnoreCase)
                                                                    || @item.ImportDetails.TINCheckStatus.Equals("6", StringComparison.InvariantCultureIgnoreCase)
                                                                    || @item.ImportDetails.TINCheckStatus.Equals("7", StringComparison.InvariantCultureIgnoreCase)
                                                                    || @item.ImportDetails.TINCheckStatus.Equals("8", StringComparison.InvariantCultureIgnoreCase))
                                                    {
                                                        <img style="width:25px; height:25px" title='TIN match successful' src="@Url.Content("~/Images/true.png")" />
                                                    }
                                                    else
                                                    {

                                                        <img style="width:25px; height:25px" title='@item.ImportDetails.TINCheckRemarks' src="@Url.Content("~/Images/false.png")" />

                                                    }
                                                }

                                            }


                                        </td>
                                        <td align="center">
                                            @{

                                                if (@item.SubmissionStatus != null)
                                                {

                                                    if (@item.SubmissionStatus.StatusId == 2)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/Generated.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 3)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/oneCorrectionRequired.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 4)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/oneCorrectionUploaded.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 5)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/resubmitted.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 6)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/submitted.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 7)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/TwoCorrectionRequired.png")" />
                                                    }
                                                    else if (@item.SubmissionStatus.StatusId == 8)
                                                    {
                                                        <img style="width:25px; height:25px" title='@item.SubmissionStatus.Status.Name' src="@Url.Content("~/Images/TwoCorrectionUploaded.png")" />
                                                    }
                                                }
                                            }
                                        </td>

                                    </tr>
                                                        }
                                                    }
                                                }
                    }
                </tbody>
            </table>

        </div>

        <div class="col-md-12">
            <hr />

            @{
                if (Request.IsAuthenticated && User.IsInRole("Admin"))
                {
                    <button class="btn  btn-primary" type="submit" name="tinmatching" value="TIN Matching Input" onclick="return InitPageReload();">TIN Matching Input</button>
                    <button class="btn  btn-primary" type="submit" name="irstest" value="IRS FIRE Test Input" onclick="return InitPageReload();">IRS FIRE Test Input</button>
                    <button class="btn  btn-primary" type="submit" name="irs" value="IRS FIRE Input" onclick="return InitPageReload();">IRS FIRE Input </button>
                    <button class="btn  btn-primary" type="submit" name="irscorrection" value="IRS FIRE Correction Input" onclick="return InitPageReload();">IRS FIRE Correction Input</button>

                    <div class="dropup" style="float:right">
                        <button class="btn btn-success dropdown-toggle" type="submit" data-toggle="dropdown">
                            Change Status
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="submitForm(1);">Not Submitted</a></li>
                            <li><a href="#" onclick="submitForm(6);">Submitted</a></li>
                            <li class="divider"></li>
                            <li><a href="#" onclick="submitForm(3);">One-Transaction Correction</a></li>
                            <li><a href="#" onclick="submitForm(7);">Two-Transaction Correction</a></li>

                        </ul>
                    </div>
                    <button class="btn  btn-primary" type="submit" name="generatepdf" value="Generate PDF File" onclick="return InitPageReload();">Generate PDF File </button>
                }

            }
        </div>
                }
</div>
<link rel="stylesheet" type="text/css" href="~/Content/DataTables/datatables.min.css" />

<style>
    input[type="checkbox"] {
        height: 18px;
        width: 18px;
    }

    .dataTable thead .sorting:after, .dataTable thead .sorting_asc:after {
        content: '';
    }

    .dataTable thead .sorting:before {
        content: '';
        margin-top: -2px;
        color: #999;
    }

    .dataTable thead .sorting_desc:after {
        content: '';
    }

    .dataTables_filter > label:after {
        content: "";
        font-family: icomoon;
        font-size: 12px;
        display: inline-block;
        position: absolute;
        top: 50%;
        right: 12px;
        margin-top: -6px;
        color: #999;
        line-height: 1;
        -webkit-font-smoothing: antialiased;
    }
</style>